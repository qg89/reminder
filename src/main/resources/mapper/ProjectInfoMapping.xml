<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.q.reminder.reminder.mapper.ProjectInfoMapping">
    <select id="getWeeklyDocxList" resultType="com.q.reminder.reminder.vo.WeeklyProjectVo">
        SELECT
            p.pm_key AS pmKey,
            p.folder_token AS folder_token,
            p.project_short_name AS projectShortName,
            p.redmine_type AS redmineType,
            p.start_day AS startDay,
            p.pm_ou AS pmOu,
            p.p_key AS pKey,
            p.id AS id,
            fw.url AS weeklyReportUrl,
            fw.week_num weekNum,
            fw.file_name AS fileName,
            fw.file_token AS fileToken,
            fs.`name` AS pmName
        FROM
            r_project_info p
            LEFT JOIN fs_weekly_project_report fw ON p.id = fw.r_pid
            LEFT JOIN fs_user_member_info fs ON p.pm_ou = fs.member_id
        WHERE
            fw.file_token IS NOT NULL
            AND fw.is_delete = 0
            AND p.is_delete = 0
            AND p.weekly_type = 0
        <choose>
            <when test="weekNumber > 0">
                AND fw.week_num = #{weekNumber}
            </when>
            <otherwise>
                AND fw.week_num = WEEKOFYEAR(NOW())
            </otherwise>
        </choose>
        <if test="id != null and id != ''">
            AND p.id = #{id}
        </if>
    </select>

    <select id="weeklyByProjectList" resultType="com.q.reminder.reminder.vo.WeeklyByProjectVo">
        SELECT
            fw.file_name AS fileName,
            fw.url AS weeklyReportUrl,
            fw.week_num AS weekNum
        FROM
            r_project_info p,
            fs_weekly_project_report fw
        WHERE
            p.id = fw.r_pid
          AND fw.file_token IS NOT NULL
          AND p.id = #{id}
        <if test="name != null and name != ''">
            AND fw.file_name like concat('%',#{name},'%')
        </if>
          AND fw.is_delete = 0
        ORDER BY
            week_num DESC
    </select>

    <select id="getProjectCost" resultType="java.util.Map">
        SELECT
            a.projectId,
            IFNULL(sum( a.cost ),0) cost
        FROM
            (
                SELECT
                    ( sc.cost * up.hours ) AS cost,
                    up.projectId,
                    up.ym
                FROM
                    s_user_cost sc,
                    (
                        SELECT
                            sum( userByHours.hours )/ sum( userByYM.hours ) hours,
                            userByHours.projectId,
                            userByHours.ym,
                            userByHours.userId
                        FROM
                            (
                                SELECT
                                    SUM( re.hours ) hours,
                                    re.userId,
                                    re.projectId,
                                    DATE_FORMAT( re.spentOn, '%Y%m' ) ym
                                FROM
                                    rd_time_entry re,
                                    r_project_info rp
                                WHERE
                                    rp.is_delete = 0
                                  AND rp.p_id = re.projectId
                                GROUP BY
                                    re.userId,
                                    re.projectId,
                                    DATE_FORMAT( re.spentOn, '%Y%m' )
                            ) AS userByHours,
                            (
                                SELECT
                                    SUM( re.hours ) hours,
                                    re.userId,
                                    DATE_FORMAT( re.spentOn, '%Y%m' ) ym
                                FROM
                                    rd_time_entry re,
                                    r_project_info rp
                                WHERE
                                    rp.is_delete = 0
                                  AND rp.p_id = re.projectId
                                GROUP BY
                                    re.userId,
                                    DATE_FORMAT( re.spentOn, '%Y%m' )) AS userByYM
                        WHERE
                            userByHours.userId = userByYM.userId
                          AND userByHours.ym = userByYM.ym
                        GROUP BY
                            userByHours.projectId,
                            userByHours.ym,
                            userByHours.userId
                    ) up
                WHERE
                    up.userId = sc.user_id
            ) a
        GROUP BY
            a.projectId
    </select>
</mapper>
