<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.q.reminder.reminder.mapper.WGroupMapping">
    <select id="groupWorkload" resultType="com.q.reminder.reminder.vo.RoleInvolvementVo">
        SELECT
            g.`group` AS `name`,
            dc.`month` AS `months`,
            ROUND( SUM( ut.hours ), 2 ) AS `hours`
        FROM
            w_group g
            LEFT JOIN w_role_group_user re ON g.id = re.group_id
            LEFT JOIN rd_time_entry ut ON re.user_id = ut.userId
            LEFT JOIN r_project_info p ON p.id = ut.projectId
            LEFT JOIN w_user_time_month um ON um.user_id = re.user_id
            LEFT JOIN s_date_config dc ON um.date_id = dc.id
            LEFT JOIN w_config wc ON dc.id = wc.date_id
        WHERE
         dc.`year` = #{vo.year}
        AND p.redmine_type = 2
        AND CONCAT( dc.`year`, dc.`month` ) = DATE_FORMAT( ut.`spentOn`, '%Y%c' )
        <if test="vo.ids != null and vo.ids.size > 0 ">
            AND p.id in(
            <foreach collection="vo.ids" item="item" separator=",">
                #{item}
            </foreach>
            )
        </if>
        <if test="vo.groupId != null and vo.groupId.size() > 0">
            AND g.id IN(
            <foreach collection="vo.groupId" item="item" separator=",">
                #{item}
            </foreach>
            )
        </if>
        <if test="vo.roleId != null and vo.roleId.size() > 0">
            AND re.role_id IN(
            <foreach collection="vo.roleId" item="item" separator=",">
                #{item}
            </foreach>
            )
        </if>
        <if test="vo.userId != null and vo.userId.size() > 0">
            AND re.user_id IN(
            <foreach collection="vo.userId" item="item" separator=",">
                #{item}
            </foreach>
            )
        </if>
        GROUP BY
            g.`group`,
            dc.`month`
    </select>
</mapper>

