<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.q.reminder.reminder.mapper.WRoleMapping">
    <select id="roleInvolvement" resultType="com.q.reminder.reminder.vo.RoleInvolvementVo">
        SELECT
            r.role AS `name`,
            r.sort,
            IFNULL( DATE_FORMAT( ut.`spentOn`, '%c' ), 0 ) AS `months`,
            ROUND(
                IFNULL( SUM( ut.hours )/ 8 /(
                SELECT
                    c.days
                FROM
                    `w_config` c
                    LEFT JOIN s_date_config d ON d.id = c.date_id
                WHERE
                   d.`month` = `months`
                    AND d.`year` = #{vo.year}
                    ), 0 ), 2
                ) hours
        FROM
            w_role r
            LEFT JOIN w_role_group_user re ON r.id = re.role_id
            LEFT JOIN rd_time_entry ut ON re.user_id = ut.userId
            LEFT JOIN r_project_info p ON p.p_id = ut.projectId
        WHERE
            DATE_FORMAT( ut.`spentOn`, '%Y' ) = #{vo.year}
            <if test="vo.ids != null and vo.ids.size > 0 ">
                AND p.id in(
                <foreach collection="vo.ids" item="item" separator=",">
                    #{item}
                </foreach>
                )
            </if>
        GROUP BY
            r.role, r.sort,`months`
    </select>
</mapper>

