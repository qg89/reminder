<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.q.reminder.reminder.mapper.WRoleMapping">
    <select id="roleInvolvement" resultType="com.q.reminder.reminder.vo.RoleInvolvementVo">
        SELECT
            r.role AS `name`,
            IFNULL( DATE_FORMAT( ut.`day`, '%c' ), 0 ) AS `months`,
            ROUND(
                IFNULL( SUM( ut.houses )/ 8 /(
                SELECT
                    c.days
                FROM
                    `w_config` c
                        LEFT JOIN s_date_config d ON d.id = c.date_id
                WHERE
                   d.`month` = `months`
                    AND d.`year` = #{vo.year}
                    ), 0 ), 2
                ) hours
        FROM
            w_role r
            LEFT JOIN w_role_group_user re ON r.id = re.role_id
            LEFT JOIN w_user_times ut ON re.user_id = ut.user_id
            LEFT JOIN r_project_info p ON p.id = ut.p_id
        WHERE
            p.p_key = #{vo.pKey}
          AND DATE_FORMAT( ut.`day`, '%Y' ) = #{vo.year}
        GROUP BY
            r.role, `months`
    </select>
</mapper>

