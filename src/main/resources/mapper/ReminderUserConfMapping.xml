<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.q.reminder.reminder.mapper.ReminderUserConfMapping">

    <select id="listByUser" resultType="com.q.reminder.reminder.vo.UserReminderVo">
        SELECT
            t.member_id AS memberId,
            t.`date` AS spentOn,
            t.`name` AS userName,
            t.userId,
            IFNULL(te.hours, 0) AS hours,
            t.start_date AS startDate,
            t.end_date AS endDate,
            t.`enable`
        FROM
        (
            SELECT
                dc.`date`,
                ui.`name`,
                ui.member_id,
                rui.assignee_id as userId,
                ui.start_date,
                ui.end_date,
                ui.`enable`
            FROM
                s_holiday_config dc,
                s_reminder_user_conf ui
            LEFT JOIN r_redmine_user_info rui ON ui.`name` = REPLACE(rui.assignee_name,' ','')
            WHERE
                dc.`date` >= #{beginOfWeek}
                AND dc.`date` <![CDATA[<=]]> DATE_SUB(NOW(),INTERVAL 1 DAY)
                AND `work` = 1
                AND rui.redmine_type = 2
            GROUP BY
                dc.`date`,
                ui.member_id,
                rui.assignee_id
        ) t
        LEFT JOIN rd_time_entry te ON t.`date` = te.spentOn AND REPLACE ( te.userName, ' ', '' ) = t.`name`
        HAVING `enable` = 0
    </select>
</mapper>

