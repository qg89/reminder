<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.q.reminder.reminder.mapper.ReminderUserConfMapping">

    <select id="listByUser" resultType="com.q.reminder.reminder.vo.UserReminderVo">
        SELECT
            t.member_id AS memberId,
            t.`date` AS spentOn,
            t.`name` AS userName,
            t.userId,
            te.hours,
            uc.start_date AS startDate,
            uc.end_date AS endDate,
            uc.`enable`
        FROM
        (
            SELECT
                dc.`date`,
                ui.`name`,
                ui.member_id,
                rui.assignee_id as userId
            FROM
                s_holiday_config dc,
                fs_user_member_info ui
            LEFT JOIN r_redmine_user_info rui ON ui.`name` = REPLACE(rui.assignee_name,' ','')
            WHERE
                dc.`date` >= #{beginOfWeek}
                AND dc.`date` <![CDATA[<=]]> DATE_SUB(NOW(),INTERVAL 1 DAY)
                AND ui.resign = 0
                AND ui.is_delete = 0
                AND `work` = 1
                AND rui.redmine_type = 2
            GROUP BY
                dc.`date`,
                ui.member_id,
                rui.assignee_id
        ) t
        LEFT JOIN rd_time_entry te ON t.`date` = te.spentOn AND REPLACE ( te.userName, ' ', '' ) = t.`name`
        LEFT JOIN s_reminder_user_conf uc ON t.member_id = uc.member_id
    </select>
</mapper>

